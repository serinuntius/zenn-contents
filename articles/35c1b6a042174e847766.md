---
title: "UniswapãŒ1200ã‚‚ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãƒˆãƒ¼ã‚¯ãƒ³é…å¸ƒã—ãŸæ–¹æ³•ãŒè³¢ã™ãã‚‹ã®ã§ãƒ¡ãƒ¢"
emoji: "ğŸ¦„"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Uniswap", "Ethereum", "MarkleTree", "Solidity"]
published: true
---

ä»•çµ„ã¿ã¨ã—ã¦ã¯ã€ãƒãƒ¼ã‚¯ãƒ«ãƒ„ãƒªãƒ¼ã‚’ä½¿ã£ãŸç‰©ã€‚

ã“ã‚Œã ã‘ã§å¯Ÿã—ã®ã„ã„äººã¯æ°—ã¥ã„ã¦ã—ã¾ã£ãŸã‹ã‚‚w

https://github.com/Uniswap/merkle-distributor

## ã©ã†ã‚„ã£ãŸã‹ï¼Ÿ
1. Uniswapã‚’åˆ©ç”¨ã—ãŸäººã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’é›†ã‚ã‚‹
2. æœ€åˆã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£é…å¸ƒæ™‚ã«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒ1200å€‹ã ã£ãŸã‚‰ã—ã„
2. ãƒãƒ¼ã‚¯ãƒ«ãƒ„ãƒªãƒ¼ã‚’ä½¿ã£ã¦1200ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’åœ§ç¸®ã—ã¦ãƒãƒ¼ã‚¯ãƒ«ãƒ«ãƒ¼ãƒˆã‚’è¨ˆç®—ã™ã‚‹
3. ãƒãƒ¼ã‚¯ãƒ«ãƒ«ãƒ¼ãƒˆã ã‘ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«å…¥ã‚Œã¦ãŠã
4. ãƒãƒ¼ãƒ‰ã€ãƒ„ãƒªãƒ¼ã€ãƒ«ãƒ¼ãƒˆã‚’æ¸¡ã—ã¦ã€æ¤œè¨¼ã™ã‚‹
```sol
// https://github.com/Uniswap/merkle-distributor/blob/master/contracts/MerkleDistributor.sol#L34-L47
    function claim(uint256 index, address account, uint256 amount, bytes32[] calldata merkleProof) external override {
        require(!isClaimed(index), 'MerkleDistributor: Drop already claimed.');

        // Verify the merkle proof.
        bytes32 node = keccak256(abi.encodePacked(index, account, amount));
        require(MerkleProof.verify(merkleProof, merkleRoot, node), 'MerkleDistributor: Invalid proof.');

        // Mark it claimed and send the token.
        _setClaimed(index);
        require(IERC20(token).transfer(account, amount), 'MerkleDistributor: Transfer failed.');

        emit Claimed(index, account, amount);
    }

// https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/cryptography/MerkleProof.sol
...
  function verifyProof(bytes _proof, bytes32 _root, bytes32 _leaf) public pure returns (bool) {
    // Check if proof length is a multiple of 32
    if (_proof.length % 32 != 0) return false;

    bytes32 proofElement;
    bytes32 computedHash = _leaf;

    for (uint256 i = 32; i <= _proof.length; i += 32) {
      assembly {
        // Load the current element of the proof
        proofElement := mload(add(_proof, i))
      }

      if (computedHash < proofElement) {
        // Hash(current computed hash + current element of the proof)
        computedHash = keccak256(computedHash, proofElement);
      } else {
        // Hash(current element of the proof + current computed hash)
        computedHash = keccak256(proofElement, computedHash);
      }
    }
```
ãƒãƒ¼ã‚¯ãƒ«ãƒ„ãƒªãƒ¼é–¢ä¿‚ãªã„ã‘ã©ã€ã‚ã¡ã‚ƒãã¡ã‚ƒãƒ†ã‚¯ã„åœ§ç¸®ã‚‚ã—ã¦ã„ã‚‹wè„±å¸½w

```sol
// https://github.com/Uniswap/merkle-distributor/blob/c3255bfa2b684594ecd562cacd7664b0f18330bf/contracts/MerkleDistributor.sol#L12-L32
    mapping(uint256 => uint256) private claimedBitMap;

    function isClaimed(uint256 index) public view override returns (bool) {
        uint256 claimedWordIndex = index / 256;
        uint256 claimedBitIndex = index % 256;
        uint256 claimedWord = claimedBitMap[claimedWordIndex];
        uint256 mask = (1 << claimedBitIndex);
        return claimedWord & mask == mask;
    }

    function _setClaimed(uint256 index) private {
        uint256 claimedWordIndex = index / 256;
        uint256 claimedBitIndex = index % 256;
        claimedBitMap[claimedWordIndex] = claimedBitMap[claimedWordIndex] | (1 << claimedBitIndex);
    }
```

## ã“ã‚Œã®ã©ã“ãŒã™ã”ã„ã®ã‹ï¼Ÿ
- ãƒãƒ¼ã‚¯ãƒ«ãƒ„ãƒªãƒ¼ã‚’ä½¿ã£ã¦ã€ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’32byteã¾ã§ã«åœ§ç¸®ã—ã¦ã„ã‚‹
    - ç´ äººãŒã“ã‚Œã‚’å®Ÿè£…ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ mapping(address => bool)ã¨ã‹ã§è¡¨ç¾ã—ã¦ã€24kbã¨ã‹ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆä½¿ã£ã¦ã—ã¾ã†(1/750ã‚‚ç¯€ç´„ã§ãã¦ã‚‹)
- ã©ã‚“ã ã‘ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¢—ãˆã¦ã‚‚åŒã˜ã‚³ã‚¹ãƒˆã§æ¤œè¨¼å¯èƒ½
- Ethereumã¯ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆãŒé«˜ã„
    - calldata(é–¢æ•°ã®å¼•æ•°)ã¯æ¯”è¼ƒçš„å®‰ã„ã®ã§ã€ãƒªãƒ¼ãƒ•ã‚’å…¨éƒ¨å¤–ã«å‡ºã—ã¦ã—ã¾ã†ã£ã¦ã®ã¯å¤§ã‚¢ãƒª

## ã„ãã‚‰ç¯€ç´„ã§ããŸã®ã‹ï¼Ÿ
ã‚¬ãƒã‚¬ãƒãƒ•ã‚§ãƒ«ãƒŸæ¨å®šã§é©å½“ã«å‡ºã™ã€‚

2020å¹´ 9æœˆé ­ã®ã¯å¹³å‡ 120Gweiãã‚‰ã„ã ã£ãŸã¿ãŸã„ã€‚

![](https://storage.googleapis.com/zenn-user-upload/6io64t24fuc4eqk0f8zry865ly0f)

### ç´ ç›´ã«ERC20ã§ã‚ã‚‹Uniã‚’1200ã‚¢ãƒ‰ãƒ¬ã‚¹ã«é€é‡‘ã—ãŸå ´åˆã‚’è€ƒãˆã‚‹
![](https://storage.googleapis.com/zenn-user-upload/2wiwh1whvloijzzkgin8c9czqub5)

å½“æ™‚ã®Ethä¾¡å€¤ã®ä¾¡å€¤ã«æ›ç®—ã™ã‚‹ãŸã‚ã«20%ã‹ã‘ã‚‹ã€‚
`1200 address * $14 * 20% = $3,360`

**$3,360**ã¯ãˆãã„ï¼

### ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã§åˆ©ç”¨è€…ã«å¼•å‡ºã•ã›ã‚‹
å¤šåˆ†ã“ã‚ŒãŒã€Token Distributorã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãŒä½œã‚‰ã‚ŒãŸæ™‚ã®txã€‚
https://etherscan.io/tx/0x1d80567e3e5946d391a72125f57f203732f8dd706ce6007e4a729a592b8624cd

å½“æ™‚ã®ã‚¬ã‚¹ä»£ã ã¨ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã®ã«ã‹ã‹ã£ãŸã®ã¯ `$33`ï¼ï¼ï¼å®‰ã„ï¼
![](https://storage.googleapis.com/zenn-user-upload/x9mzwpgmrhr95rr9xeg6nrftm5pk)

åˆ©ç”¨è€…å…¨å“¡ã®ã‚¬ã‚¹ä»£ã‚’è€ƒãˆã‚‹ã¨ã€$12ãã‚‰ã„ã§claimã§ãã‚‹ã¿ãŸã„ãªã®ã§ã€
`$12 * 1200 =` **$14,400**
ã¨ã„ã†æ„Ÿã˜ã§ã€å…¨å“¡ã®ã‚³ã‚¹ãƒˆã§ã„ã†ã¨å‰²é«˜ã«ãªã£ã¦ã—ã¾ã†ã€‚

ã¾ã‚ã€ã“ã‚Œã®ä½•ãŒå¤§äº‹ã£ã¦ã€ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãŒå¤§é‡‘ã‚’ç”¨æ„ã›ãšã¨ã‚‚ãªã‚“ã¨ã‹ãªã‚‹ã£ã¦ã¨ã“ã‚ã§ã™ã­ã€‚

## ã¾ã¨ã‚
Uniswapã¯é ­ã‚’ä½¿ã£ã¦ã€ãªã‚‹ã¹ãå°‘ãªã„ã‚³ã‚¹ãƒˆã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é…å¸ƒã—ãŸï¼
ç¯€ç´„é‡‘é¡ã§ã„ã†ã¨Uniswapã¯ $3,327ã¤ã¾ã‚Šã€35ä¸‡å††ãã‚‰ã„ç¯€ç´„ã§ããŸã‚ã‘ã§ã™ã€‚
è³¢ã„ï¼

## å‚è€ƒ
https://github.com/Uniswap/merkle-distributor
