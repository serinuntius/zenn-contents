---
title: "Plonky2ã¨ã„ã†ã‚¼ãƒ­çŸ¥è­˜è¨¼æ˜ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹EVMã®è¨¼æ˜ã‚’ãƒãƒ©è¦‹ã—ã¦ã¿ã‚‹"
emoji: "ğŸ™Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Ethereum", "ã‚¼ãƒ­çŸ¥è­˜è¨¼æ˜", "Plonky2"]
published: true
publication_name: noplan_inc
---

## ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã¯[Rust Advent Calendar 2022](https://qiita.com/advent-calendar/2022/rust)ã®19æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

æœ¬å½“ã¯CosmWASMã§æ®‹é«˜ã‚’ç§˜åŒ¿ã™ã‚‹ã‚³ã‚¤ãƒ³ã‚’ä½œã£ã¦ç´¹ä»‹ã—ã‚ˆã†ã¨æ€ã£ãŸã®ã§ã™ãŒã€å®Ÿè£…ãŒé–“ã«åˆã„ã¾ã›ã‚“ã§ã—ãŸ ğŸ™

Rustã¨å€‹äººçš„ãªèˆˆå‘³ã§ã‚ã‚‹ã‚¯ãƒªãƒ—ãƒˆãŒãƒãƒƒãƒã—ã¦ã„ãã†ãªåˆ†é‡ã®ã€Œã‚¼ãƒ­çŸ¥è­˜è¨¼æ˜ã€ã® `Plonky2` ã®EVMã«ã¤ã„ã¦ãƒãƒ©è¦‹ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

æŠ•ç¨¿ãŒé…ã‚Œã¦ã—ã¾ã£ã¦ç”³ã—è¨³ãªã„ã§ã™ã€‚

## ã‚¼ãƒ­çŸ¥è­˜è¨¼æ˜ã¨ã¯ï¼Ÿ

>ã‚¼ãƒ­çŸ¥è­˜è¨¼æ˜ã¨ã¯ã€ç§˜å¯†ã‚’çŸ¥ã£ã¦ã„ã‚‹ã“ã¨ã‚’ç§˜å¯†ã‚’æ•™ãˆã‚‹ã“ã¨ãªãã€ç¬¬ä¸‰è€…ã«ç§˜å¯†ã‚’çŸ¥ã£ã¦ã„ã‚‹ã¨è¨¼æ˜ã§ãã‚‹ä»•çµ„ã¿ã®ã“ã¨ã§ã™ã€‚
ã“ã“ã§ã¯ã‚ã¾ã‚Šæ·±å…¥ã‚Šã—ã¾ã›ã‚“ãŒã€zkRollupã‚’ä½œã‚‹ä¸Šã§å¤§åˆ‡ãªç‰¹å¾´ãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œã¯ã€å¤§é‡ã®è¨ˆç®—ã‚’æ­£ã—ãè¡Œã£ãŸã“ã¨ã‚’è¨¼æ‹ ã‚’è¦‹ã‚‹ã ã‘ã§æ¤œè¨¼ã§ãã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚ [zkRollupã®å›è·¯å†…ã§è¨ˆç®—ã—ã¦ã‚‹ã“ã¨](https://zenn.dev/noplan_inc/articles/f56b3dc2871a03)

ä»¥é™ZKPã¨ã—ã¾ã™ã€‚

## Ethereumã¨EVMã¨ã¯ï¼Ÿ
Ethereumã¯ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã®1ã¤ã§ã™ã€‚
EVMã¯ã€Ethereumã«æ¡ç”¨ã•ã‚Œã¦ã„ã‚‹VMã®ã“ã¨ã§ã™ã€‚


## Plonky2ã¨ã¯ï¼Ÿ
mir-protocolãŒé–‹ç™ºã—ãŸå†å¸°çš„ãªZKPã‚’é«˜é€ŸåŒ–ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

## ã‚·ãƒ³ãƒ—ãƒ«ãªé€é‡‘txã«ã¤ã„ã¦è¦‹ã¦ã¿ã‚‹
[ã‚·ãƒ³ãƒ—ãƒ«ãªæ–°ã—ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã¸ã®é€é‡‘ãƒ†ã‚¹ãƒˆ](https://github.com/mir-protocol/plonky2/blob/main/evm/tests/transfer_to_new_addr.rs)ãŒã‚ã£ãŸã®ã§ã€ãã¡ã‚‰ã«æ—¥æœ¬èªã§é©å½“ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥ã‚Œã¦ã„ãã¾ã™ã€‚

```rust
/// Test a simple token transfer to a new address.
#[test]
fn test_simple_transfer() -> anyhow::Result<()> {
    init_logger();

    let all_stark = AllStark::<F, D>::default();
    let config = StarkConfig::standard_fast_config();

    // ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚
    let sender = hex!("2c7536e3605d9c16a7a3d7b1898e529396a65c23");
    let to = hex!("a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0");

    // keccakã¨ã¯Ethereumã§ã‚ˆãä½¿ã‚ã‚Œã‚‹ãƒãƒƒã‚·ãƒ¥é–¢æ•°ã§ã™ã€‚
    let sender_state_key = keccak(sender);
    let to_state_key = keccak(to);
    let sender_nibbles = Nibbles::from(sender_state_key);
    let to_nibbles = Nibbles::from(to_state_key);
    let value = U256::from(100u32);

    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™ã€‚
    let sender_account_before = AccountRlp {
        nonce: 5.into(),
        balance: eth_to_wei(100_000.into()),
        storage_root: PartialTrie::Empty.calc_hash(),
        // code_hashãŒç©ºã£ã¦ã“ã¨ã¯EOAã‚’è¡¨ã—ã¦ã„ã‚‹ã®ã‹ã‚‚
        code_hash: keccak([]),
    };

    // Ethereumã§ã¯Bitcoinã®ã‚ˆã†ãªã‚·ãƒ³ãƒ—ãƒ«ãªMerkle Treeã§ã¯ãªãã€Merkle Patricia Trieã¨ã„ã†æœ¨æ§‹é€ ãŒåˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
    // https://docs.rs/eth_trie_utils/0.3.0/eth_trie_utils/partial_trie/enum.PartialTrie.html
    let state_trie_before = PartialTrie::Leaf {
        nibbles: sender_nibbles,
        // RLPã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã¨ã¯ã€Recursive Length Prefixã®ç•¥ã§ã€Ethereumã§ã‚ˆãç›®ã«ã—ã¾ã™ã€‚
        // >RLPã¯é«˜åº¦ã«æœ€å°åŒ–ã—ãŸã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã€ãƒã‚¹ãƒˆã•ã‚ŒãŸByteé…åˆ—ã‚’ä¿å­˜ã™ã‚‹ç›®çš„ã®ãŸã‚ã«ã‚ã‚‹ã€‚
        // >protobufã‚„BSONãªã©ã¨ã¯é•ã£ã¦ã€Booleanã‚„Floatã€Doubleã‚„Integerã•ãˆå®šç¾©ã—ãªã„
        // ã ãã†ã§ã™ã€‚
        value: rlp::encode(&sender_account_before).to_vec(),
    };
    let tries_before = TrieInputs {
        state_trie: state_trie_before,
        transactions_trie: PartialTrie::Empty,
        receipts_trie: PartialTrie::Empty,
        storage_tries: vec![],
    };

    // Generated using a little py-evm script. py-evmã§äº‹å‰ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ã„ãŸã‚ˆã†ã§ã™ã€‚
    let txn = hex!("f861050a8255f094a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0648242421ba02c89eb757d9deeb1f5b3859a9d4d679951ef610ac47ad4608dc142beb1b7e313a05af7e9fbab825455d36c36c7f4cfcafbeafa9a77bdff936b52afb36d4fe4bcdd");

    let block_metadata = BlockMetadata::default();

    let inputs = GenerationInputs {
        signed_txns: vec![txn.to_vec()],
        tries: tries_before,
        contract_code: HashMap::new(),
        block_metadata,
    };

    let mut timing = TimingTree::new("prove", log::Level::Debug);

    // ZKã®prove(è¨¼æ˜)ã‚’ã“ã“ã§ã‚„ã£ã¦ã„ã¾ã™ã€‚EVMãŒæ­£ã—ã„æŒ™å‹•ã‚’ã—ã¦ã„ã‚‹ã¨ã„ã†è¨¼æ˜ã‚’ã—ã¦ã„ã¾ã™ã€‚
    let proof = prove::<F, C, D>(&all_stark, &config, inputs, &mut timing)?;
    timing.filter(Duration::from_millis(100)).print();

    // txã®å¾Œã§æœŸå¾…ã™ã‚‹å‹•ä½œã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚
    let expected_state_trie_after = {
        // é€é‡‘ã—ãŸã®ã§ã€æ®‹é«˜ãŒæ¸›ã£ã¦ã„ã‚‹
        let sender_account_after = AccountRlp {
            balance: sender_account_before.balance - value, // TODO: Also subtract gas_used * price. ã¾ã ã‚¬ã‚¹ãƒ—ãƒ©ã‚¤ã‚¹ã®è¨ˆç®—ã¯è¡Œãªã£ã¦ã„ãªã„ã‚ˆã†ã§ã†sã€‚
            // nonce: sender_account_before.nonce + 1, // TODO: ã¾ã nonceãŒã†ã¾ãå‹•ã„ã¦ã„ãªã„ã‚ˆã†ã§ã†sã€‚
            ..sender_account_before
        };
        let to_account_after = AccountRlp {
            balance: value,
            ..AccountRlp::default()
        };

        let mut children = std::array::from_fn(|_| PartialTrie::Empty.into());
        children[sender_nibbles.get_nibble(0) as usize] = PartialTrie::Leaf {
            nibbles: sender_nibbles.truncate_n_nibbles_front(1),
            value: rlp::encode(&sender_account_after).to_vec(),
        }
        .into();
        children[to_nibbles.get_nibble(0) as usize] = PartialTrie::Leaf {
            nibbles: to_nibbles.truncate_n_nibbles_front(1),
            value: rlp::encode(&to_account_after).to_vec(),
        }
        .into();
        PartialTrie::Branch {
            children,
            value: vec![],
        }
    };

    // ZK Proofã®state rootã¨ç´ ã§è¨ˆç®—ã—ãŸé€é‡‘å¾Œã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒ«ãƒ¼ãƒˆã‚’æ¯”è¼ƒã™ã‚‹
    assert_eq!(
        proof.public_values.trie_roots_after.state_root,
        expected_state_trie_after.calc_hash()
    );

    // proof(è¨¼æ‹ )ã®verify(æ¤œè¨¼)ã‚‚ã‚„ã£ã¦ãŠã
    verify_proof(all_stark, proof, &config)
}
```

## ã¾ã¨ã‚
é§†ã‘è¶³ã§ã—ãŸãŒã€ã–ã£ãã‚Šè¨¼æ˜ã®éç¨‹ã¨è¨¼æ˜ã«ã¤ã„ã¦è¦‹ã‚Œã¾ã—ãŸã€‚
Proveã®ä¸­èº«ã‚’è¦‹ã‚‹ã¨å¤§å¤‰ãªã“ã¨ã«ãªã‚Šãã†ã§ã™ã­ã€‚


æ˜æ—¥ã¯[@namn1125](https://qiita.com/namn1125)ã•ã‚“ã§ã™ã€ãŠé¡˜ã„ã—ã¾ã™ï¼

## no planæ ªå¼ä¼šç¤¾ã«ã¤ã„ã¦
- no planæ ªå¼ä¼šç¤¾ã¯ã€ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³æŠ€è¡“ã€Webã‚µã‚¤ãƒˆé–‹ç™ºã€ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªé–‹ç™ºã€ãƒãƒ¼ãƒ è‚²æˆã€ãªã©Webã‚µãƒ¼ãƒ“ã‚¹å…¨èˆ¬ã®é–‹ç™ºã‹ã‚‰é‹ç”¨ã‚„æ•™è‚²ã€æ”¯æ´ãªã©ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚ã‚ˆãã‚ã‹ã‚‰ãªã„ã€ãµã‚ãµã‚ã—ãŸãƒãƒ¼ãƒ—ãƒ©ãƒ³çŠ¶æ…‹ã§ã‚‚å¤§ä¸ˆå¤«ï¼ã”ä¸€ç·’ã«ãƒ—ãƒ©ãƒ³ã‚’ç«‹ã¦ã¦ã„ãã¾ã—ã‚‡ã†ï¼
- [no planæ ªå¼ä¼šç¤¾ã«ã¤ã„ã¦](https://noplan-inc.com)
- [no planæ ªå¼ä¼šç¤¾ | ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³å®Ÿç¸¾](https://noplan-inc.com/blockchain)
- [no planæ ªå¼ä¼šç¤¾ | ãƒ–ãƒ­ã‚°ä¸€è¦§](https://noplan-inc.com/blog)

## å¤–éƒ¨ãƒªãƒ³ã‚¯ãƒ»å‚è€ƒæ–‡çŒ®
- [zkRollupã®å›è·¯å†…ã§è¨ˆç®—ã—ã¦ã‚‹ã“ã¨](https://zenn.dev/noplan_inc/articles/f56b3dc2871a03)
- [Ethereumã®RLPã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã«ã¤ã„ã¦-Yellow Paper AppendixBã‚ˆã‚Š](https://www.blockchainengineer.tokyo/entry/ethereum-rlp-encoding)
- [Merkle Patricia Trieã®æ§‹é€ ã¨ãƒœãƒˆãƒ«ãƒãƒƒã‚¯](https://techmedia-think.hatenablog.com/entry/2021/03/20/225733)