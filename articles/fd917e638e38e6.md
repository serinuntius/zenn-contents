---
title: "Honoã§ä½œã‚‹ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãªAPI(ã‚’å®Œæˆã•ã›ãŸã‹ã£ãŸãƒ»ãƒ»ãƒ»)"
emoji: "ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["hono", "cloudflare", "d1", "drizzleorm"]
published: true
publication_name: noplan_inc
published_at: 2023-12-12
---



## ã¯ã˜ã‚ã«

ã“ã‚“ã«ã¡ã¯ã€œï¼çš†æ§˜ã„ã‹ãŒãŠéã”ã—ã§ã—ã‚‡ã†ã‹ï¼Ÿã€€no plan inc. CTOã® [@serinuntius](https://twitter.com/_serinuntius) ã§ã™ã€‚
ã“ã‚Œã¯[no plan inc.ã® Advent Calendar 2023](https://qiita.com/advent-calendar/2023/noplan_inc)ã®12æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

ãšã£ã¨Honoã‚’ä½¿ã£ã¦ä½•ã‹ã‚’ä½œã£ã¦ã¿ãŸã„ã¨æ€ã£ã¦ã„ã¾ã—ã¦ã€ä½œã£ã¦ãŠãã¨ä¾¿åˆ©ãã†ãªã‚‚ã®ã‚’ä½œã‚Šã¾ã—ãŸã€‚
ãƒ†ãƒ¼ãƒã¯Line Messaging APIã§ã™ã€‚

## èª²é¡Œ
Lineã®Messaging APIã‚’**ç„¡æ–™**ã§åˆ©ç”¨ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€å‹é”è¿½åŠ ã—ã¦ãã‚ŒãŸuserIdã®ãƒªã‚¹ãƒˆãŒã§ãã¾ã›ã‚“ã€‚

:::message
ã‚‚ã¡ã‚ã‚“æœ‰æ–™ã®APIã§ã¯å‹é”è¿½åŠ ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¹ãƒˆå¾—ã‚‹ã“ã¨ã¯ã§ãã‚‹ã‚ˆã†ã§ã™ã€‚

>ã“ã®æ©Ÿèƒ½ã¯èªè¨¼æ¸ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¾ãŸã¯ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã¿ã§ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç¨®åˆ¥ã«ã¤ã„ã¦è©³ã—ãã¯ã€ã€LINEãƒ¤ãƒ•ãƒ¼ for Businessã€ã®ã€ŒLINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç¨®åˆ¥ (opens new window)ã€ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
https://developers.line.biz/ja/reference/messaging-api/#get-follower-ids
:::

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ï¼”ã¤ã®æ–¹æ³•ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚

1. é–‹ç™ºè€…ãŒè‡ªåˆ†è‡ªèº«ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—ã™ã‚‹
1. Webhookã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—ã™ã‚‹
1. å‹ã ã¡å…¨å“¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—ã™ã‚‹
1. ã‚°ãƒ«ãƒ¼ãƒ—ãƒˆãƒ¼ã‚¯ã‚„è¤‡æ•°äººãƒˆãƒ¼ã‚¯ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—ã™ã‚‹


ç„¡æ–™ã§æ™®é€šã®ç”¨é€”ã§è€ƒãˆã‚‹ã¨2ã®Webhookã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—ã™ã‚‹ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚
ãŸã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚ŠãŸã„ã ã‘ãªã®ã«ã€ã„ã¡ã„ã¡Webhookã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã®ã¯DRYã˜ã‚ƒã‚ã‚Šã¾ã›ã‚“ã€‚

Lineã®ãƒ€ãƒ¡ãªã¨ã“ã‚ã‚’ã„ã„æ„Ÿã˜ã«ãƒ©ãƒƒãƒ—ã—ã¦ãã‚Œã‚‹APIã‚’ä½œæˆã™ã‚Œã°ã€ä»Šå¾ŒLine botã‚’ä½œæˆã™ã‚‹ã¨ãã«æ—ã‚‹ã‚“ã˜ã‚ƒãªã„ã‹ã¨è€ƒãˆã¾ã—ãŸã€‚

ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã®å…±æœ‰ãŒã§ããŸã¨ã“ã‚ã§ã€ç’°å¢ƒã‚’ä½œæˆã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
```bash
pnpm create hono my-app

create-hono version 0.3.2
âœ” Using target directory â€¦ my-app
? Which template do you want to use? â€º - Use arrow-keys. Return to submit.
    aws-lambda
    bun
    cloudflare-pages
â¯   cloudflare-workers # ä»Šå›ã¯Cloudflare Workersã‚’ä½¿ã„ãŸã„ã®ã§ã“ã¡ã‚‰ã‚’é¸æŠ
    deno
    fastly
    lagon
    lambda-edge
    netlify
  â†“ nextjs

cd my-app
pnpm i
```

ã¾ãšã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã¦ã¿ã‚‹
```bash
pnpm dev

> @ dev /private/tmp/my-app
> wrangler dev src/index.ts

 â›…ï¸ wrangler 3.19.0
-------------------
â” Starting local server...
[wrangler:inf] Ready on http://localhost:8787
```

ã“ã‚“ãªæ„Ÿã˜ã®å‡ºåŠ›ãŒå‡ºã‚‹ã®ã§ã€ `http://localhost:8787` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```bash
curl http://localhost:8787

Hello Hono!
```

ã¨å‡ºåŠ›ã•ã‚Œã¾ã—ãŸã‹ï¼Ÿ

è©¦ã—ã« `src/index.ts` ã‚’é©å½“ã«ã‚¨ãƒ‡ã‚£ãƒƒãƒˆã—ã¦ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ–‡å­—åˆ—ã‚’å¤‰ãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚

å½“ãŸã‚Šå‰ã®ã‚ˆã†ã«ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ãŒã•ã‚Œã¾ã—ãŸã­ï¼Ÿæœ€é«˜ã ãœï¼

```bash
curl http://localhost:8787

Hello Hono!!!!
```

## wranglerã®ãƒ­ã‚°ã‚¤ãƒ³ã‚’ã—ã¦ãŠã
wranglerã¨ã„ã†Cloudflareã®ç®¡ç†ç”¨cliã‚³ãƒãƒ³ãƒ‰ãŒã‚ã‚Šã¾ã—ã¦ã€D1ã®æ“ä½œã‚„Workersã®ãƒ‡ãƒ—ãƒ­ã‚¤ã®éš›ã«ä½¿ã„ã¾ã™ã€‚
ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã€é€£æºã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

```bash
pnpm wrangler login
```

## d1ã¨drizzleã§CRUDã‚’ä½œã‚‹
d1ã¨ã„ã†serverlessã® SQL DatabaseãŒã‚ã‚Šã¾ã™ã€‚ã“ã„ã¤ã‚’DBã«ã—ã¦CRUDã‚’ä½œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

d1ã¯ã¾ã ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ™ãƒ¼ã‚¿ãªç‚ºã€å¯¾å¿œã—ã¦ã„ã‚‹ORMãŒå°‘ãªã„ã§ã™ã€‚

è»½ãèª¿ã¹ãŸçµæœ `drizzle` ã¨ã„ã†ORMãŒæœ‰åŠ›ãã†ã ã£ãŸã®ã§ã€ãã¡ã‚‰ã‚’ä½¿ã£ã¦ã¿ã¾ã™ã€‚

## d1ã®DBã‚’ä½œã‚‹
```bash
pnpm wrangler d1 create <DB-NAME>

âœ… Successfully created DB 'test-db' in region APAC
Created your database using D1's new storage backend. The new storage backend is not yet recommended for production
workloads, but backs up your data via point-in-time restore.

[[d1_databases]]
binding = "DB" # i.e. available in your Worker on env.DB
database_name = "test-db"
database_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
```

ã“ã‚“ãªæ„Ÿã˜ã§å‡ºåŠ›ã•ã‚Œã‚‹ã®ã§ã€ `d1_database` ä»¥ä¸‹ã®ã¨ã“ã‚ã‚’ `wrangler.toml`ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚

```toml: wrangler.toml
name = "my-app"
compatibility_date = "2023-01-01"
main = "src/index.ts"

# [vars]
# MY_VARIABLE = "production_value"

# [[kv_namespaces]]
# binding = "MY_KV_NAMESPACE"
# id = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

# [[r2_buckets]]
# binding = "MY_BUCKET"
# bucket_name = "my-bucket"

[[d1_databases]]
binding = "DB" # i.e. available in your Worker on env.DB
database_name = "test-db"
database_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
```

## drizzleã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

```bash
pnpm add drizzle-orm drizzle-zod
pnpm add -D drizzle-kit
```

## DBã®shemaã‚’ä½œæˆã—ã¦ã„ãã¾ã™
é©å½“ã«ä»Šå›ã®ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã‚’ã—ã¦ã¿ã¾ã—ãŸã€‚ä¸€æ—¦ã“ã‚“ãªæ„Ÿã˜ã§è¡Œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```ts: src/schema.ts
import { sqliteTable, integer, text } from "drizzle-orm/sqlite-core";
import { createInsertSchema, createSelectSchema } from 'drizzle-zod';

export const users = sqliteTable('users', {
    id: integer("id", { mode: "number" }).primaryKey({ autoIncrement: true }),
    name: text("name"),
    lineUserId: text("lineUserId").notNull().unique("lineUserId"),
    createdAt: integer("createdAt", { mode: "timestamp" }).notNull(),
    updatedAt: integer("updatedAt", { mode: "timestamp" }).notNull()
})

export const insertUsersSchema = createInsertSchema(users);
export const selectUsersSchema = createSelectSchema(users);

export const bots = sqliteTable('bots', {
    id: integer("id", { mode: "number" }).primaryKey({ autoIncrement: true }),
    name: text("name").notNull().unique("name"),
    lineChannelAccessToken: text("lineChannelAccessToken").notNull(),
    createdAt: integer("createdAt", { mode: "timestamp" }).notNull(),
    updatedAt: integer("updatedAt", { mode: "timestamp" }).notNull()
})

export const insertBotsSchema = createInsertSchema(bots);
export const selectBotsSchema = createSelectSchema(bots);

export const messages = sqliteTable('messages', {
    id: integer("id", { mode: "number" }).primaryKey({ autoIncrement: true }),
    userId: integer("userId", { mode: "number" }).notNull(),
    botId: integer("botId", { mode: "number" }).notNull(),
    text: text("text").notNull(),
    createdAt: integer("createdAt", { mode: "timestamp" }).notNull(),
    updatedAt: integer("updatedAt", { mode: "timestamp" }).notNull()
})

export const insertMessagesSchema = createInsertSchema(messages);
export const selectMessagesSchema = createSelectSchema(messages);
```

ä»–ã®è¨˜äº‹ã§ã¯ã“ã‚“ãªæ„Ÿã˜ã§timestampã®è¨­å®šã‚’ã—ã¦ã„ãŸã®ã§ã™ãŒã€ç§ã®ç’°å¢ƒã§ã¯å‹•ãã¾ã›ã‚“ã§ã—ãŸã€‚
```ts
.default(
    sql`(strftime('%s', 'now'))`
  ),
```

èª¿æŸ»ã«1mmã‚‚æ™‚é–“ä½¿ã£ã¦ãªã„ã§ã™ãŒã€ãªã—ã«ã—ãŸã‚‰ã¨ã‚Šã‚ãˆãšå‹•ã„ãŸã®ã§ã€ãã‚Œã§é€²ã‚ã¾ã—ãŸã€‚

## drizzle.config.tsã‚’ä½œæˆã™ã‚‹
drizzleã‚’ã„ã„æ„Ÿã˜ã«å‹•ã‹ã™ãŸã‚ã®ã‚³ãƒ³ãƒ•ã‚£ã‚°ã§ã™ã€‚é©å®œè‡ªç”±ã«è¨­å®šã—ã¦ã„ãŸã ã„ã¦ã‚‚çµæ§‹ã§ã™ãŒã€ä»–ã®å ´æ‰€ã§å‚ç…§ã—ã¦ãŸã‚Šã™ã‚‹ã®ã§ã€ã¨ã‚Šã‚ãˆãšã¯ã“ã‚Œã¨åŒã˜ã«ã—ã¦ãŠãã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

```ts: drizzle.config.ts
import type { Config } from "drizzle-kit";

export default {
  schema: "./src/schema.ts",
  out: "./drizzle/migrations",
  driver: "d1",
  dbCredentials: {
    wranglerConfigPath: "wrangler.toml",
    dbName: "<DATABASE-NAME>", # FIXME
  },
} satisfies Config;
```

## migrationãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹
scriptsã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ç™»éŒ²ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚
```json: package.json
...
    "generate": "pnpm drizzle-kit generate:sqlite"
...
```

```bash
pnpm generate
> @ generate /private/tmp/my-app
> pnpm drizzle-kit generate:sqlite

drizzle-kit: v0.20.6
drizzle-orm: v0.29.1

No config path provided, using default 'drizzle.config.ts'
Reading config file '/private/tmp/my-app/drizzle.config.ts'
3 tables
bots 5 columns 1 indexes 0 fks
messages 6 columns 0 indexes 0 fks
users 5 columns 1 indexes 0 fks

[âœ“] Your SQL migration file âœ drizzle/migrations/0000_needy_phil_sheldon.sql ğŸš€
```

ã“ã‚“ãªæ„Ÿã˜ã§migrationãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚ŒãŸã‚‰æˆåŠŸã§ã™ï¼


## migrations_dirã‚’è¨­å®šã™ã‚‹

```toml: wrangler.toml
[[d1_databases]]
binding = "DB" # i.e. available in your Worker on env.DB
database_name = "test-db"
database_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
# è¿½è¨˜ã™ã‚‹
migrations_dir = "drizzle/migrations"
```

## localã«å¯¾ã—ã¦migrationã—ã¦ã¿ã‚‹
package.jsonã®scriptsã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ç™»éŒ²ã—ã¦ãŠãã¾ã™ã€‚
```json: package.json
...
    "migrate:local": "wrangler d1 migrations apply <DB-NAME> --local",
    "migrate": "wrangler d1 migrations apply <DB-NAME>"
...
```

ã§ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«å¯¾ã—ã¦migrateã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```bash
pnpm migrate:local

> @ migrate:local /private/tmp/my-app
> wrangler d1 migrations apply test-db --local

Migrations to be applied:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ name                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0000_needy_phil_sheldon.sql â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
âœ” About to apply 1 migration(s)
Your database may not be available to serve requests during the migration, continue? â€¦ yes
ğŸŒ€ Mapping SQL input into an array of statements
ğŸŒ€ Executing on local database test-db (f676b3fc-ed0a-479c-8c29-7381ebc91c23) from .wrangler/state/v3/d1:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ name                        â”‚ status â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0000_needy_phil_sheldon.sql â”‚ âœ…       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ã¯ã„ã€æˆåŠŸã—ã¾ã—ãŸï¼

ã¤ã„ã§ã«æœ¬ç•ªã‚‚ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

```bash
pnpm migrate
```

## è¿½åŠ ã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å…¥ã‚Œã‚‹
zodãŒãªã„ã¨ç”Ÿãã‚Œãªã„èº«ä½“ã«ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚
```bash
pnpm add zod @hono/zod-validator
```
## CRUDã‚’å®Ÿè£…ã—ã¦ã„ã

ä¾‹ãˆã°botã¯ã“ã‚“ãªæ„Ÿã˜ã§å®Ÿè£…ã—ã¾ã—ãŸã€‚

```ts: src/bindings.d.ts
export type Bindings = {
    DB: D1Database;
};
```

CRUDã‚’é›‘ã«å®Ÿè£…ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ `c.json()` ã®ã¨ã“ã‚ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸã€‚Dateå‹ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã§ããªã„ã£ã¦ã„ã†ã‚¨ãƒ©ãƒ¼ã§ã™ã­ã€‚
é›‘ã«ã“ã‚“ãªæ„Ÿã˜ã§å¯¾å‡¦ã—ã¾ã—ãŸãŒã€ã‚‚ã£ã¨ã„ã„æ–¹æ³•ã‚ã‚Šãã†ãƒ»ãƒ»ãƒ»ã€‚
```ts: src/utils/db.ts
export function convertDatesToStr(data: any): any {
    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®`Date`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ISOæ–‡å­—åˆ—ã«å¤‰æ›
    for (const key in data) {
        if (data[key] instanceof Date) {
            data[key] = data[key].toISOString();
        }
    }
    return data;
}
```

```ts: src/bot.ts

import { drizzle } from "drizzle-orm/d1";
import { Hono } from "hono";
import { Bindings } from "./bindings";
import { bots, insertBotsSchema } from "./schema";
import { convertDatesToStr } from "./utils/db";
import { z } from 'zod'

import { zValidator } from '@hono/zod-validator'
import { eq } from "drizzle-orm";

// D1ä½¿ãˆã‚‹ã‚ˆã†ã«Bindingsã‚’æ¸¡ã™
const botRoute = new Hono<{ Bindings: Bindings }>();

botRoute.get('/', async (c) => {
    const db = drizzle(c.env.DB);
    const result = await db.select().from(bots).all();
    return c.json(convertDatesToStr(result));
})

// zValidatorã¯ã„ã„ãï¼ˆå¾Œã§è§£èª¬ã—ã¾ã™ï¼‰
botRoute.get('/:id', zValidator('json', z.object({
    id: z.number()
})), async (c) => {
    const { id } = c.req.valid('json');
    const db = drizzle(c.env.DB);
    const result = await db.select().from(bots).where(eq(bots.id, id)).limit(1).get();
    return c.json(convertDatesToStr(result));
})

// DBã®schemaã‹ã‚‰insertã«å¿…è¦ãªå‹ã‚’ä½œæˆã—ã¦ãã‚Œã‚‹ (drizzle-zodã®é­”æ³•)
// ãŸã timestampã¯ã‚µãƒ¼ãƒãƒ¼å´ã§ç”Ÿæˆã—ãŸã„ã®ã§ã€é©å½“ã«omitã—ã¦ã‚‹
botRoute.post('/', zValidator('json', insertBotsSchema.omit({ createdAt: true, updatedAt: true})), async (c) => {
    const { name, lineChannelAccessToken } = c.req.valid('json');
    const db = drizzle(c.env.DB);
    const result = await db.insert(bots).values({
        name,
        lineChannelAccessToken,
        createdAt: new Date(),
        updatedAt: new Date()
    }).execute();
    return c.json(convertDatesToStr(result));
});

botRoute.delete('/:id', zValidator('json', z.object({
    id: z.number()
})), async (c) => {
    const { id } = c.req.valid('json');
    const db = drizzle(c.env.DB);

    const result = await db.delete(bots).where(eq(bots.id, id)).execute();
    return c.json(convertDatesToStr(result));
});

export { botRoute }
```

ãƒ«ãƒ¼ãƒˆã¯ã“ã‚“ãªæ„Ÿã˜

```ts: src/index.ts
import { Hono } from 'hono'
import { logger } from 'hono/logger'
import { showRoutes } from 'hono/dev'
import { webhooksRoute } from './webhooks'
import { usersRoute } from './user';
import { botRoute } from './bot';
import { Bindings } from './bindings';

const app = new Hono<{ Bindings: Bindings }>()

// ãƒ­ã‚¬ãƒ¼ã‚’è¿½åŠ 
app.use('*', logger());

app.route('/api/webhooks', webhooksRoute);
app.route('/api/users', usersRoute)
app.route('/api/bots', botRoute)

export default app

// ã„ã„æ„Ÿã˜ã«Railsã¿ãŸã„ãªãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ã¦ãã‚Œã‚‹
showRoutes(app)
```

webhooksã®ã¨ã“ã‚ã¨usersã®ã¨ã“ã‚ã‚‚ã»ã¼ä¸€ç·’ã§ç‰¹ã«ä½•ã‚‚ãªã„ã®ã§ãã‚“ãªæ„Ÿã˜ã§ãƒ»ãƒ»ãƒ»ã€‚ï¼ˆæœ¬å½“ã¯æ™‚é–“ã‚ã‚Œã°ã¡ã‚ƒã‚“ã¨LINEã¨ã®é€£æºã¾ã§ã‚„ã‚ŠãŸã‹ã£ãŸãƒ»ãƒ»ãƒ»ï¼‰


## deployã—ã¦ã¿ã‚‹
```bash
pnpm run deploy # pnpmã«ã¯deployã¨ã„ã†ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ãŒã‚ã‚‹ã®ã§ã€æ··åŒã•ã‚Œãªã„ã‚ˆã†ã«runã‚’ã¤ã‘ã‚‹
# https://pnpm.io/ja/cli/deploy
```

å‹•ä½œç¢ºèªã—ã¦ã¿ã‚‹
```bash
curl https://<app name>.<user name>.workers.dev/api/bots
[]
```

ä½•ã‚‚å…¥ã£ã¦ãªã„ã®ã§ãã‚Œã¯ãã†w

é©å½“ã«ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¦ã¿ã‚ˆã†ã€‚
```bash
curl -X POST -H 'Content-Type: application/json' -d '{"name": "test20", "lineChannelAccessToken": "hoge"}' https://<app name>.<user name>.workers.dev/api/bots
{"success":true,"meta":{"served_by":"v3-prod","duration":0.2303,"changes":1,"last_row_id":3,"changed_db":true,"size_after":45056,"rows_read":3,"rows_written":3},"results":[]}%       
```

ã‚‚ã†ä¸€åº¦ç¢ºèªã—ã¦ã¿ã‚‹
```bash
curl https://<app name>.<user name>.workers.dev/api/bots | jq .
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   404  100   404    0     0   3568      0 --:--:-- --:--:-- --:--:--  3672
[
  {
    "id": 1,
    "name": "test20",
    "lineChannelAccessToken": "hoge",
    "createdAt": "2023-12-11T15:29:39.000Z",
    "updatedAt": "2023-12-11T15:29:39.000Z"
  }
]
```

ã†ã¾ãã„ãã¾ã—ãŸï¼


## ã¾ã¨ã‚
Honoã¯æœ¬å½“ã«ã™ã”ã„ã€‚Cloudflareã‚‚ã™ã”ã„ã€‚D1ã‚‚ã™ã”ã„ã€‚zodã‚‚ã™ã”ã„ã€‚

èªå½™åŠ›ãŒä½ä¸‹ã—ã¦ã—ã¾ã†ã»ã©ã€æ„Ÿå‹•ã—ã¾ã—ãŸã€‚
ãƒ‡ãƒ—ãƒ­ã‚¤ãŒã‚ã¡ã‚ƒãã¡ã‚ƒé€Ÿã„ã®ã„ã„ã§ã™ã­ã€‚

æŸFunctionsã¨ã‹ã©ã‚“ã ã‘æ™‚é–“ã‹ã‹ã‚‹ã‹ãƒ»ãƒ»ãƒ»ã€‚


## no planæ ªå¼ä¼šç¤¾ã«ã¤ã„ã¦
- no planæ ªå¼ä¼šç¤¾ã¯ **ã€Œãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã®åŠ›ã§ZEROã‹ã‚‰æœªæ¥ã‚’å‰µé€ ã™ã‚‹ã€ç²¾é‹­ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼é›†å›£ã€** ã§ã™ã€‚
- ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³/AIæŠ€è¡“ã‚’ã¯ã˜ã‚ã¨ã—ãŸã€Webã‚µã‚¤ãƒˆé–‹ç™ºã€ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªé–‹ç™ºã€ãƒãƒ¼ãƒ è‚²æˆã€ãªã©Webã‚µãƒ¼ãƒ“ã‚¹å…¨èˆ¬ã®é–‹ç™ºã‹ã‚‰é‹ç”¨ã‚„æ•™è‚²ã€æ”¯æ´ãªã©ã‚‚è¡Œã£ã¦ã„ã¾ã™ã€‚ã‚ˆãã‚ã‹ã‚‰ãªã„ã€ãµã‚ãµã‚ã—ãŸãƒãƒ¼ãƒ—ãƒ©ãƒ³çŠ¶æ…‹ã§ã‚‚å¤§ä¸ˆå¤«ï¼ã”ä¸€ç·’ã«ãƒ—ãƒ©ãƒ³ã‚’ç«‹ã¦ã¦ã„ãã¾ã—ã‚‡ã†ï¼
- [no planæ ªå¼ä¼šç¤¾ã«ã¤ã„ã¦](https://noplan-inc.com)
- [no planæ ªå¼ä¼šç¤¾ | web3å®Ÿç¸¾](https://noplan-inc.com/web3)
- [no planæ ªå¼ä¼šç¤¾ | ãƒ–ãƒ­ã‚°ä¸€è¦§](https://noplan-inc.com/blog)

ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®æ¡ç”¨ã‚‚ç©æ¥µçš„ã«è¡Œãªã£ã¦ã„ã¾ã™ã®ã§ã€èˆˆå‘³ãŒã‚ã‚‹æ–¹ã¯æ˜¯éã”é€£çµ¡ãã ã•ã„ï¼
- [CTOã®DMã¯ã“ã¡ã‚‰](https://twitter.com/_serinuntius)


## å‚è€ƒæ–‡çŒ®
https://hono.dev/getting-started/cloudflare-workers
https://hono.dev/guides/validation#with-zod
https://developers.cloudflare.com/d1/
https://qiita.com/kmkkiii/items/2b22fa53a90bf98158c0
https://github.com/drizzle-team/drizzle-orm/tree/main/examples/cloudflare-d1
https://github.com/drizzle-team/drizzle-orm/tree/main/drizzle-zod
https://developers.line.biz/ja/docs/messaging-api/receiving-messages/#webhook-event-types